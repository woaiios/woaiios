<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Test - User Text</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .test-text {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-left: 4px solid #4CAF50;
            border-radius: 5px;
        }
        .result.info {
            border-left-color: #2196F3;
        }
        .result.success {
            border-left-color: #4CAF50;
        }
        .result.warning {
            border-left-color: #ff9800;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .performance-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            margin: 0 5px;
        }
        .performance-badge.excellent {
            background: #4CAF50;
            color: white;
        }
        .performance-badge.good {
            background: #8BC34A;
            color: white;
        }
        .performance-badge.fair {
            background: #FFC107;
            color: black;
        }
        .performance-badge.poor {
            background: #FF5722;
            color: white;
        }
        #logs {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Performance Test - User-Provided Text</h1>
        
        <div class="test-text" id="testText">In 1970 geologists Kenneth J. Hsu and William B. F. Ryan were collecting research data 
while aboard the oceanographic research vessel Glomar Challenger. An objective of this 
particular cruise was to investigate the floor of the Mediterranean and to resolve questions 
about its geologic history. One question was related to evidence that the invertebrate fauna 
(animals without spines) of the Mediterranean had changed abruptly about 6 million years 
ago. Most of the older organisms were nearly wiped out, although a few hardy species 
survived. A few managed to migrate into the Atlantic. Somewhat later, the migrants returned, 
bringing new species with them. Why did the near extinction and migrations occur? 
2 Another task for the Glomar Challenger's scientists was to try to determine the origin of the 
domelike masses buried deep beneath the Mediterranean seafloor. These structures had been 
detected years earlier by echo-sounding instruments, but they had never been penetrated in the 
course of drilling. Were they salt domes such as are common along the United States Gulf 
Coast, and if so, why should there have been so much solid crystalline salt beneath the floor of 
the Mediterranean? 
3 With questions such as these clearly before them, the scientists aboard the Glomar Challenger
proceeded to the Mediterranean to search for the answers. On August 23, 1970, they 
recovered a sample. The sample consisted of pebbles of hardened sediment that had once been 
soft, deep-sea mud, as well as granules of gypsum1 and fragments of volcanic rock. Not a 
single pebble was found that might have indicated that the pebbles came from the nearby 
continent. In the days following, samples of solid gypsum were repeatedly brought on deck as 
drilling operations penetrated the seafloor. Furthermore, the gypsum was found to possess 
peculiarities of composition and structure that suggested it had formed on desert flats. 
Sediment above and below the gypsum layer contained tiny marine fossils, indicating open 
ocean conditions. As they drilled into the central and deepest part of the Mediterranean basin, 
the scientists took solid, shiny, crystalline salt from the core barrel. Interbedded with the salt 
were thin layers of what appeared to be windblown silt.</div>

        <button id="runTest">Run Performance Test</button>
        <button id="clearCache">Clear Cache & Retry</button>
        
        <div id="progress"></div>
        
        <div id="results"></div>
        
        <div id="logs">
            <div class="log-entry">Console output will appear here...</div>
        </div>
    </div>

    <script type="module">
        import { WordDatabase } from './js/WordDatabase.js';
        import { TextAnalyzer } from './js/TextAnalyzer.js';
        import { VocabularyManager } from './js/VocabularyManager.js';
        import { SettingsManager } from './js/SettingsManager.js';

        const logsDiv = document.getElementById('logs');
        const originalLog = console.log;
        const originalError = console.error;
        
        function addLog(message, type = 'log') {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.color = type === 'error' ? '#ff5555' : '#0f0';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };

        const resultsDiv = document.getElementById('results');
        const progressDiv = document.getElementById('progress');
        const testTextElement = document.getElementById('testText');

        let wordDatabase = null;
        let textAnalyzer = null;
        let vocabularyManager = null;
        let settingsManager = null;

        function addResult(message, className = '') {
            const result = document.createElement('div');
            result.className = `result ${className}`;
            result.innerHTML = message;
            resultsDiv.appendChild(result);
        }

        function getPerformanceBadge(ms, target) {
            if (ms < target * 0.5) return '<span class="performance-badge excellent">Excellent</span>';
            if (ms < target) return '<span class="performance-badge good">Good</span>';
            if (ms < target * 1.5) return '<span class="performance-badge fair">Fair</span>';
            return '<span class="performance-badge poor">Needs Improvement</span>';
        }

        async function runTest() {
            resultsDiv.innerHTML = '';
            addResult('üöÄ <b>Starting performance test with user-provided text...</b>', 'info');
            
            const text = testTextElement.textContent;
            
            // Extract words
            addResult('üìù <b>Extracting words from text...</b>', 'info');
            const words = textAnalyzer.extractWords(text);
            const uniqueWords = [...new Set(words.map(w => w.toLowerCase()))];
            
            addResult(`‚úì Extracted <b>${words.length}</b> total words, <b>${uniqueWords.length}</b> unique words`);
            
            // Test 1: Analyze words (first time - may be cold)
            addResult('<br>üß™ <b>Test 1: Full text analysis (includes word extraction, difficulty calculation, translation)</b>', 'info');
            
            const startAnalysis = performance.now();
            const analysis = await textAnalyzer.analyzeWords(
                words,
                settingsManager.getSetting('difficultyLevel'),
                settingsManager.getSetting('highlightMode'),
                { learning: vocabularyManager.learningWords, mastered: vocabularyManager.masteredWords }
            );
            const analysisTime = performance.now() - startAnalysis;
            
            const target = uniqueWords.length > 100 ? 100 : 50;
            addResult(`‚úì Analysis completed in <b>${analysisTime.toFixed(2)}ms</b> ${getPerformanceBadge(analysisTime, target)}`);
            addResult(`&nbsp;&nbsp;- Average: <b>${(analysisTime / uniqueWords.length).toFixed(2)}ms</b> per unique word`);
            addResult(`&nbsp;&nbsp;- Highlighted words: <b>${analysis.highlightedWords.length}</b>`);
            addResult(`&nbsp;&nbsp;- New words: <b>${analysis.newWords.length}</b>`);
            addResult(`&nbsp;&nbsp;- Difficulty score: <b>${analysis.difficultyScore}</b>`);
            
            // Test 2: Re-analyze (should be faster with cache)
            addResult('<br>üß™ <b>Test 2: Re-analyzing same text (should use cache)</b>', 'info');
            
            const startReanalysis = performance.now();
            const analysis2 = await textAnalyzer.analyzeWords(
                words,
                settingsManager.getSetting('difficultyLevel'),
                settingsManager.getSetting('highlightMode'),
                { learning: vocabularyManager.learningWords, mastered: vocabularyManager.masteredWords }
            );
            const reanalysisTime = performance.now() - startReanalysis;
            
            const improvement = ((analysisTime - reanalysisTime) / analysisTime * 100).toFixed(1);
            addResult(`‚úì Re-analysis completed in <b>${reanalysisTime.toFixed(2)}ms</b> ${getPerformanceBadge(reanalysisTime, 20)}`);
            addResult(`&nbsp;&nbsp;- Cache improvement: <b>${improvement}%</b> faster`);
            
            // Test 3: Cache statistics
            if (wordDatabase.directStorage && wordDatabase.directStorage.isInitialized) {
                addResult('<br>üìä <b>Cache Statistics:</b>', 'info');
                const stats = wordDatabase.directStorage.getCacheStats();
                
                const statsHtml = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Cache Size</div>
                            <div class="stat-value">${stats.cacheSize.toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Total Queries</div>
                            <div class="stat-value">${stats.totalQueries.toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Cache Hits</div>
                            <div class="stat-value">${stats.cacheHits.toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Cache Misses</div>
                            <div class="stat-value">${stats.cacheMisses.toLocaleString()}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Hit Rate</div>
                            <div class="stat-value">${stats.hitRate}</div>
                        </div>
                    </div>
                `;
                addResult(statsHtml);
            }
            
            // Final verdict
            addResult('<br>üéØ <b>Performance Verdict:</b>', 'info');
            const targetTime = 50;
            if (reanalysisTime < targetTime * 0.5) {
                addResult(`‚úÖ <b>Excellent!</b> Text analysis is ${((targetTime / reanalysisTime) * 100).toFixed(0)}% faster than target (${targetTime}ms)`, 'success');
            } else if (reanalysisTime < targetTime) {
                addResult(`‚úÖ <b>Good!</b> Text analysis meets the ${targetTime}ms target`, 'success');
            } else {
                addResult(`‚ö†Ô∏è Analysis time (${reanalysisTime.toFixed(2)}ms) is slightly over target (${targetTime}ms). Consider warming cache first.`, 'warning');
            }
            
            addResult('<br>üí° <b>Note:</b> For the target of 300 words in <50ms, this ${uniqueWords.length}-word text demonstrates ${uniqueWords.length >= 300 ? "the system handles 300+ words efficiently" : "the performance scales well to 300+ words"}', 'info');
        }

        async function clearCacheAndRetry() {
            resultsDiv.innerHTML = '';
            addResult('üóëÔ∏è <b>Clearing caches...</b>', 'info');
            
            if (wordDatabase.queryCache) {
                wordDatabase.queryCache.clear();
            }
            if (wordDatabase.directStorage && wordDatabase.directStorage.clearCache) {
                wordDatabase.directStorage.clearCache();
            }
            
            addResult('‚úì Caches cleared. Running test with cold cache...');
            
            await runTest();
        }

        async function init() {
            progressDiv.innerHTML = '<p class="loading">Initializing database and text analyzer...</p>';
            
            try {
                // Initialize components
                wordDatabase = new WordDatabase();
                vocabularyManager = new VocabularyManager();
                settingsManager = new SettingsManager();
                
                wordDatabase.setProgressCallback((data) => {
                    progressDiv.innerHTML = `<p class="loading">Loading database: ${data.percentage.toFixed(1)}% - ${data.message || ''}</p>`;
                });
                
                const success = await wordDatabase.initialize();
                
                if (success) {
                    textAnalyzer = new TextAnalyzer(wordDatabase, null);
                    progressDiv.innerHTML = '<p style="color: #4CAF50;">‚úì Database and analyzer initialized successfully!</p>';
                    
                    document.getElementById('runTest').disabled = false;
                    document.getElementById('clearCache').disabled = false;
                } else {
                    progressDiv.innerHTML = '<p style="color: #f44336;">‚úó Failed to initialize database</p>';
                }
            } catch (error) {
                console.error('Initialization error:', error);
                progressDiv.innerHTML = '<p style="color: #f44336;">‚úó Error: ' + error.message + '</p>';
            }
        }

        // Event listeners
        document.getElementById('runTest').addEventListener('click', runTest);
        document.getElementById('clearCache').addEventListener('click', clearCacheAndRetry);
        
        // Disable buttons until initialized
        document.getElementById('runTest').disabled = true;
        document.getElementById('clearCache').disabled = true;

        // Start initialization
        init();
    </script>
</body>
</html>
